var dcomethealth = dcomethealth || {};
dcomethealth.StaffMaster = {
    id: "StaffMaster",
    init: function () {
        var _this = this;
        $("#main_navigation_bar").append('<div id="' + _this.id + '" class="main_container">');
        $("#" + _this.id).load("pages/html/" + _this.id + ".html", function () {
            dcomethealth.datatypes.applyDataTypes($("#" + _this.id));
            $('#page-header').innerHTML = 'Staff Master';
            $('.activeStatus').toggles({on: true}, "staffIsConsultant");
            $('.surgeonStatus').toggles({on: false}, "staffIsSurgeon", 0);
            $('.doctorStatus').toggles({on: false}, "staffIsAdmittingDoctor", 0);
            $('.staffStatus').toggles({on: true}, "staffValid");
            _this.fetchStaffList();
            _this.getStates();
            dcomethealth.MasterResource.searchUnit({}, function (data) {
                $('#unit_tbody').empty();
                $.each(data, function (pIdx, item) {
                    var opt1 = document.createElement("option");
                    opt1.value = item.id;
                    opt1.text = item.unitName;
                    document.getElementById('primaryUnit').options.add(opt1);
                    $('#unit_tbody').append('<tr><td><input type="checkbox" id="unitCheck" name="unitCheck"></td>\n\
                                <td><input type="text" id="unitName" name="unitName" value="' + item.unitName + '" style="border:none"/>\n\
                                    <input type="hidden" id="unitRid" name="unitRid" value="' + item.id + '"></td></tr>');
                });
            });
            $('#countryCode').val(dcomethealth.userEntityCountryCode);
            var obj = $('#patCountry').find('option[id="' + dcomethealth.userEntityCountryCode + '"]');
            $('#staffCountry').val(obj.val());
            dcomethealth.MasterResource.getRoles(function (data) {
                dcometRoles = data;
            });
            $("#roles").select2({width: 'resolve'});
            $("#staffAbbrv").change(function () {
                var searchParams = {"staffSpecialityIndex": $('#staffAbbrv option:selected').val()};
                var options = '';
                dcomethealth.MasterResource.searchStaff(searchParams, function (data) {
                    $.each(data, function (idx, Val) {
                        options += '<option value="' + Val.id + '">' + Val.staffName + '</option>';
                    });
                    $("#VDName").html(options);
                });

            });
            $("#edit_user_form").validate({
                // Specify the validation rules
                rules: {
                    staffName: "required",
                    staffContactNumber: "required",
                    staffUname: "required",
                    staffCompensation: "required",
                    FreshConsultation: "required",
                    ReviewConsultation: "required",
                    MaximumConsultation: "required",
                    staffEmail: {
                        required: true,
                        email: true
                    },
                    staffAbbrv: {
                        selectcheck: true

                    },
                    staffCategory: {
                        selectchec: true

                    }
                },
                // Specify the validation error messages
                messages: {
                    staffName: "Enter Staff Name",
                    staffContactNumber: "Enter Contact No",
                    staffUname: "Enter User Name",
                    staffEmail: "Enter Valid Email",
                    staffCompensation: "Enter Compensation",
                    FreshConsultation: "Enter Fee",
                    ReviewConsultation: "Enter Fee",
                    MaximumConsultation: "Enter Max Consultation"
                },
                submitHandler: function (form) {
                    _this.submit();
                }
            });

            jQuery.validator.addMethod('selectcheck', function (value) {
                return (value != '0');
            }, "Select Speciality");
            jQuery.validator.addMethod('selectchec', function (value) {
                return (value != '0');
            }, "Select Category");

        });
    },
    searchPostalCode: function () {
        var pincode = $('#staffPcode').val()
        var searchObj = {"zipCode": pincode, "couCode": dcomethealth.userEntityCountryCode};
        dcomethealth.DataDictionaryResource.searchByZipcode(searchObj, function (data) {
            $("#staffCity").empty();
            $.each(data, function (pIdx, data) {
                $("#staffCity").append('<option value="' + data.place + '">' + data.place + '</option>');
                $("#staffState").val(data.division1);
            });
        });
    },
    fetchStaffList: function () {
        var search = {"staffValid": 1};
        dcomethealth.MasterResource.searchStaff(search, function (data) {
            var tables = $.fn.dataTable.fnTables(true);
            $(tables).each(function () {
                $(this).dataTable().fnClearTable();
                $(this).dataTable().fnDestroy();
            });
            if (!!data) {
                $("#tbody_head").empty();
                $.each(dcomethealth.s_staff = data, function (index, s_staff) {
                    $("#tbody_head").append('<tr onclick="dcomethealth.StaffMaster.showStaffDetail(' + s_staff.id + ')" id="tr_head">\n\
                    <td>' + s_staff.staffCode + '</td><td>' + s_staff.staffName + '</td><td>' + s_staff.staffContactNumber + '</td></tr>');
                });
                $("#staffTable").dataTable({"bJQueryUI": false, "bAutoWidth": false, "bDestroy": true, });
                $('.dataTables_filter input').addClass('form-control').attr('placeholder', 'Search...');
                $('.dataTables_length select').addClass('form-control');
            } else {
                $("#tbody_head").empty();
                $("#staffTable").dataTable({"bJQueryUI": false, "bAutoWidth": false, "bDestroy": true, });
                $('.dataTables_filter input').addClass('form-control').attr('placeholder', 'Search...');
                $('.dataTables_length select').addClass('form-control');
            }
        });
    },
    showStaffDetail: function (val) {
        $.each(dcomethealth.s_staff, function (index, s_staff) {
            if (parseInt(s_staff.id) === parseInt(val)) {
                $("#StaffMasterHeader").removeClass("panel panel-primary").addClass("hidden");
                $("#add_new").removeClass("hidden").addClass("panel panel-primary");
                dcomethealth.StaffMaster.populateFields(s_staff);
            }
        });
    },
    getCity: function () {
        var searchObj = {"couCode": dcomethealth.userEntityCountryCode};
        dcomethealth.DataDictionaryResource.searchByZipcode(searchObj, function (data) {
            $.each(data, function (pIdx, s_cou_zipcode) {
                $(s_cou_zipcode).each(function () {
                    if (dcomethealth.userEntityCountryCode == s_cou_zipcode.couCode) {
                        if (s_cou_zipcode.division1 == $("#staffState").val()) {
                            $("#Cities").append('<option value="' + s_cou_zipcode.place + '">' + s_cou_zipcode.place + '</option>');
                        }
                    }
                });
            });

        });
    },
    getStates: function () {
        dcomethealth.DataDictionaryResource.searchStates({}, function (data) {
            dcomethealth.s_states = data;
            var targetContainer = targetContainer || document;
            $("datalist.dcomet-c-s_states-list", targetContainer).each(function (idx, elem) {
                $.each(dcomethealth.s_states, function (pIdx, s_states) {
                    $(s_states).each(function () {
                        if (dcomethealth.userEntityCountryCode == s_states.countryCode) {
                            $(elem).append('<option value="' + s_states.states + '">' + s_states.stateRid + '</option>');
                        }
                    });
                });
            });
        });
    },
    populateFields: function (data) {
        document.getElementById("staffRID").value = parseInt(data.id);
        document.getElementById("staffName").value = data.staffName;
        $("#staffName").val(data.staffName);
        $("#staffContactNumber").val(data.staffContactNumber);
        $("#staffDesignation").val(data.staffDesignation);
        $("#staffDOJ").val(data.staffDOJ);
        $("#staffDOL").val(data.staffDOL);
        $("#staffAccountNumber").val(data.staffAccountNumber);
        $("#staffBankName").val(data.staffBankName);
        $("#staffBankBranch").val(data.staffBankBranch);
        $("#staffIfscCode").val(data.staffIfscCode);
        $("#staffPanCardNo").val(data.staffPanCardNo);
        $("#FreshConsultation").val(data.staffFirstConsultationFee);
        $("#ReviewConsultation").val(data.staffFollowupConsultationFee);
        $("#MaximumConsultation").val(data.staffMaxConsultationNo);
        $("#staffCompensation").val(data.staffCompensation);
        $("#staffIsConsultant").val(data.staffIsConsultant);

        $('#staffAbbrv option[value="' + data.staffSpecialityIndex + '"]').prop('selected', true);
//        $("#staffAbbrv option:selected").val(data.staffSpecialityIndex);
//        $("#staffAbbrv option:selected").text(data.staffAbbrv);
//            data.staffAddress$("#staffCompensation").val();
        $("#staffState").val(data.staffState);
        $("#staffCity").empty();
        $("#staffCity").append('<option>' + data.staffCity + '</option>');
//        $("#staffCountry").val(data.staffCountry);
        $('#staffTitle option[value="' + data.staffTitle + '"]').prop('selected', true);
        $('#staffCategory option[value="' + data.staffCategory + '"]').prop('selected', true);
        $('#primaryUnit option[value="' + data.staffUnitRID + '"]').prop('selected', true);
        $.each(data.staffUnitMap, function (i, stfUnitMap) {
            var table = document.getElementById('unit_dyn_table');
            var table_length = table.rows.length;
            for (var i = 0; i <= table_length - 1; i++) {
                if (parseInt(dynTableGetNodeInRow(table.rows[i], 'unitRid').value) === parseInt(stfUnitMap.suUnitRID)) {
                    dynTableGetNodeInRow(table.rows[i], 'unitCheck').checked = true;
                }
            }
            if (parseInt(stfUnitMap.suIsPrimaryUnit) === 1) {
                $('#primaryUnit option[value="' + stfUnitMap.suUnitRID + '"]').prop('selected', true);
            }
        });
        dcomethealth.StaffMaster.searchUser(data.staffUserRID);
        dcomethealth.StaffMaster.searchResource(data.staffResourceRID);
        var staffIsConsultant = parseInt(data.staffIsConsultant);
        if (staffIsConsultant == 1) {
            $('.activeStatus').toggles({on: true}, "staffIsConsultant");
        } else {
            $('.activeStatus').toggles({on: false}, "staffIsConsultant");
        }
        var staffIsSurgeon = parseInt(data.staffIsSurgeon);
        if (staffIsSurgeon == 1) {
            $('.surgeonStatus').toggles({on: true}, "staffIsSurgeon");
            $("#doctorDiv").removeClass("hidden");

        } else {
            $('.surgeonStatus').toggles({on: false}, "staffIsSurgeon");
            $("#doctorDiv").addClass("hidden");
        }
        var staffIsAdmittingDoctor = parseInt(data.staffIsAdmittingDoctor);
        if (staffIsAdmittingDoctor == 1) {
            $('.doctorStatus').toggles({on: true}, "staffIsAdmittingDoctor");
        } else {
            $('.doctorStatus').toggles({on: false}, "staffIsAdmittingDoctor");
        }
    },
    searchResource: function (val) {
        dcomethealth.MasterResource.searchResource({id: val}, function (data) {
            $.each(data, function (index, s_Res) {
                $("#resRid").val(s_Res.id);
                $.each(s_Res.resourceAvailability, function (i, resAvail) {

                });
                var flag = 0;
                $.each(s_Res.resourceWorkingHours, function (j, resWhAvail) {
                    flag = resWhAvail.whFlag;
                    if (parseInt(resWhAvail.whFlag) === 1) {
//                        resWh.whDayOfWeek = dynTableGetNodeInRow(table2.rows[i], 'resAvilDays').value;
                        $('#collect').val(1);
                        $('#openPmd').prop('checked', true);
                        $('#datew').prop('disabled', true);
                        $("#daywise").removeClass("hidden").addClass("panel panel-primary");
                        document.getElementById('availdate').value = 0;
                        $("#datewise").removeClass("panel panel-primary").addClass("hidden");
                        var table4 = document.getElementById('dyn_table_day');
                        var x = dynTableRow(table4.rows[j]);
                        dynTableCloneRow('dyn_table_day', x);
                        var newRow = dynTableAppendRow('dyn_table_day');
                        dynTableGetNodeInRow(newRow, 'fromTime').value = resWhAvail.whFromTime;
                        dynTableGetNodeInRow(newRow, 'ToTime').value = resWhAvail.whToTime;
                        dynTableGetNodeInRow(newRow, 'resAvilWhRid').value = resWhAvail.id;
                        dynTableGetNodeInRow(newRow, 'resAvilDays').value = resWhAvail.whDayOfWeek;
                    } else if (parseInt(resWhAvail.whFlag) === 2) {
                        $('#availdate').val(1);
                        $('#datew').prop('checked', true);
                        $('#openPmd').prop('disabled', true);
                        $("#datewise").removeClass("hidden").addClass("panel panel-primary");
                        document.getElementById('collect').value = 0;
                        $("#daywise").removeClass("panel panel-primary").addClass("hidden");
                        var table3 = document.getElementById('dyn_table_date');
                        var x = dynTableRow(table3.rows[j]);
                        dynTableCloneRow('dyn_table_date', x);
                        var newRow = dynTableAppendRow('dyn_table_date');
//                                dynTableGetNodeInRow(table3.rows[i], 'resAvilRid').value = resAvail.id;
                        dynTableGetNodeInRow(newRow, 'fromTime').value = resWhAvail.whFromTime;
                        dynTableGetNodeInRow(newRow, 'ToTime').value = resWhAvail.whToTime;
                        dynTableGetNodeInRow(newRow, 'resAvilWhRid').value = resWhAvail.id;
                        dynTableGetNodeInRow(newRow, 'resAvilDateFrom').value = resWhAvail.whFromDate;
                        dynTableGetNodeInRow(newRow, 'resAvilDateTo').value = resWhAvail.whToDate;
                    }
                });
                if (parseInt(flag) === 1) {
                    var tab = document.getElementById('dyn_table_day');
                    dynTableDeleteRow(tab.rows[0]);
                } else if (parseInt(flag) === 2) {
                    var tab1 = document.getElementById('dyn_table_date');
                    dynTableDeleteRow(tab1.rows[0]);
                }
            });
        });
    },
    searchUser: function (val) {
        dcomethealth.MasterResource.searchUsers({id: val}, function (data) {
            $.each(data, function (index, s_user) {
                $("#userRid").val(s_user.id);
                $("#staffUname").val(s_user.userID);
                $("#staffEmail").val(s_user.userEmail);
            });
        });
    },
    submit: function () {
        var form = $("form");
        if (dcomethealth.StaffMaster.validateForm(form)) {
            var check = document.getElementById('openPmd');
            var check1 = document.getElementById('datew');
            if (check.checked) {
                var table = document.getElementById('dyn_table_day');
                var table_length = table.rows.length;
                for (var i = 0; i <= table_length - 1; i++) {
                    if (dynTableGetNodeInRow(table.rows[i], 'resAvilDays').value != "" && dynTableGetNodeInRow(table.rows[i], 'fromTime').value != "" && dynTableGetNodeInRow(table.rows[i], 'ToTime').value != "") {

                    } else {
                        alert("Enter All The Fields");
                        return false;
                    }
                }
            } else if (check1.checked) {
                var table1 = document.getElementById('dyn_table_date');
                var table_length1 = table1.rows.length;
                for (var i = 0; i <= table_length1 - 1; i++) {
                    if (dynTableGetNodeInRow(table1.rows[i], 'resAvilDateFrom').value != "" && dynTableGetNodeInRow(table1.rows[i], 'resAvilDateTo').value != "" && dynTableGetNodeInRow(table1.rows[i], 'fromTime').value != "" && dynTableGetNodeInRow(table1.rows[i], 'ToTime').value != "") {

                    } else {
                        alert("Enter All The Fields");
                        return false;
                    }
                }
            } else {
                alert("Select Atleast One Availability Timing Box");
                return  false;
            }
            var staff = {}, user = {}, resource = {};
            var staffList = [], resourceList = [];
            var resAvailList = [], resWhList = [];
            var resUnitMapList = [], staffUnitMapList = [];
            if ($("#userRid").val() != "") {
                user.id = $("#userRid").val();
            }
            user.userID = $("#staffUname").val();
            user.userType = "Staff";
            user.userFullName = $("#staffName").val();
//            user.userGender = $("#lensValid").val();
//            user.userDOB = $("#lensValid").val();
//            user.userStreetAddress = $("#lensValid").val();
            user.userCity = $("#staffCity").val();
            user.userCountry = $("#staffCountry").val();
            user.userPincode = $("#staffPcode").val();
            user.userPhone = $("#staffContactNumber").val();
            user.userMobile = $("#staffContactNumber").val();
            user.userEmail = $("#staffEmail").val();
            user.userValid = 1;
            user.userIsStaff = 1;
            if ($("#resRid").val() != "") {
                resource.id = $("#resRid").val();
            }
            resource.resName = $("#staffName").val();
            resource.resType = 1;
            resource.resEntRID = dcomethealth.loginuser.entityRid;
            resource.resSchedInterval = 10;
//            resource.resSchedCapacity = $("#lensValid").val();
            resource.resUnitRID = $("#primaryUnit").val();
            resource.resValid = 1;
//            resource.resContWorkingSlotCount = $("#lensValid").val();
//            resource.reseservedSlotCount = $("#lensValid").val();
            resource.portResID = 0;
            resource.resSequenceNumber = 0;
            resource.resCategory = 0;
            resource.resSubcategory = 0;
            resource.resSchedDuration = 20;
            var table = document.getElementById('unit_dyn_table');
            var table_length = table.rows.length;
            for (var i = 0; i <= table_length - 1; i++) {
                var staffUnitMap = {};
                var resourceUnitMap = {};
                var unitCheck = dynTableGetNodeInRow(table.rows[i], 'unitCheck');
                if (unitCheck.checked) {
                    if (parseInt(dynTableGetNodeInRow(table.rows[i], 'unitRid').value) === parseInt($('#primaryUnit option:selected').val())) {
                        staffUnitMap.suIsPrimaryUnit = 1;
                    } else {
                        staffUnitMap.suIsPrimaryUnit = 0;
                    }
                    staffUnitMap.suUnitRID = dynTableGetNodeInRow(table.rows[i], 'unitRid').value;
                    resourceUnitMap.ruUnitRID = dynTableGetNodeInRow(table.rows[i], 'unitRid').value;
                    resUnitMapList.push(resourceUnitMap);
                    staffUnitMapList.push(staffUnitMap);
                }
            }
            if (parseInt($('#collect').val()) === 1) {
                var table2 = document.getElementById('dyn_table_day');
            } else if (parseInt($('#availdate').val()) === 1) {
                var table2 = document.getElementById('dyn_table_date');
            }
            var table_length2 = table2.rows.length;
            for (var i = 0; i <= table_length2 - 1; i++) {
                var resAvail = {};
                var resWh = {};
                if (dynTableGetNodeInRow(table2.rows[i], 'resAvilRid').value != "") {
                    resAvail.id = dynTableGetNodeInRow(table2.rows[i], 'resAvilRid').value;
                }
                resAvail.availUnitRID = $("#primaryUnit").val();
//                resAvail.availFromDateTime = dynTableGetNodeInRow(table.rows[i], 'skuRid').value;
//                resAvail.availToDateTime = dynTableGetNodeInRow(table.rows[i], 'skuRid').value;
                resAvail.availIsUserSpecified = 1;
                resAvail.availFromDateFromTime = moment(dynTableGetNodeInRow(table2.rows[i], 'fromTime').value, 'HH:mm').format('HH:mm:ss');
                resAvail.availToDateToTime = moment(dynTableGetNodeInRow(table2.rows[i], 'ToTime').value, 'HH:mm').format('HH:mm:ss');
//                resAvail.availStyle = dynTableGetNodeInRow(table.rows[i], 'skuRid').value;
//                resAvail.availReason = dynTableGetNodeInRow(table.rows[i], 'skuRid').value;

                if (dynTableGetNodeInRow(table2.rows[i], 'resAvilWhRid').value != "") {
                    resWh.id = dynTableGetNodeInRow(table2.rows[i], 'resAvilWhRid').value;
                }
                resWh.whEntityRID = dcomethealth.loginuser.entityRid;

//                resWh.whToDate = dynTableGetNodeInRow(table.rows[i], 'skuRid').value;
                if (parseInt($('#collect').val()) === 1) {
                    resWh.whDayOfWeek = dynTableGetNodeInRow(table2.rows[i], 'resAvilDays').value;
                    resAvail.availFlag = 1;
                    resWh.whFlag = 1;
                }
                if (parseInt($('#availdate').val()) === 1) {
                    resWh.whFromDate = dynTableGetNodeInRow(table2.rows[i], 'resAvilDateFrom').value;
                    resWh.whToDate = dynTableGetNodeInRow(table2.rows[i], 'resAvilDateTo').value;
                    resAvail.availFlag = 2;
                    resWh.whFlag = 2;
                }
                resWh.whFromTime = moment(dynTableGetNodeInRow(table2.rows[i], 'fromTime').value, 'HH:mm').format('HH:mm:ss');
                resWh.whToTime = moment(dynTableGetNodeInRow(table2.rows[i], 'ToTime').value, 'HH:mm').format('HH:mm:ss');
//                resWh.whType;
                resWh.whUnitRID = $("#primaryUnit").val();
                resWhList.push(resWh);
                resAvailList.push(resAvail);
            }
            var RID = $("#staffRID").val();
            if (RID == "") {
                RID = null;
            }
            staff.id = RID;
            staff.staffUnitRID = $("#primaryUnit").val();
            staff.staffEntityRID = dcomethealth.loginuser.entityRid;
            staff.staffName = $("#staffName").val();
            staff.staffCategory = $("#staffCategory").val();
            staff.staffContactNumber = $("#staffContactNumber").val();
            staff.staffDesignation = $("#staffDesignation").val();
            staff.staffDOJ = $("#staffDOJ").val();
            staff.staffDOL = $("#staffDOL").val();
            staff.staffValid = 1;
            staff.staffIsConsultant = $("#staffIsConsultant").val();
            if ($("#staffIsSurgeon").val() == "undefined") {
                staff.staffIsSurgeon === 0;
            } else {
                staff.staffIsSurgeon = $("#staffIsSurgeon").val();
            }
            if ($("#staffIsAdmittingDoctor").val() == "undefined") {
                staff.staffIsAdmittingDoctor === 0;
            } else {
                staff.staffIsAdmittingDoctor = $("#staffIsAdmittingDoctor").val();
            }

            if ($("#staffAccountNumber").val() !== "") {
                staff.staffAccountNumber = $("#staffAccountNumber").val();
            }
            if ($("#staffBankName").val() !== "") {
                staff.staffBankName = $("#staffBankName").val();
            }
            if ($("#staffBankBranch").val() !== "") {
                staff.staffBankBranch = $("#staffBankBranch").val();
            }
            if ($("#staffIfscCode").val() !== "") {
                staff.staffIfscCode = $("#staffIfscCode").val();
            }
            if ($("#staffPanCardNo").val() !== "") {
                staff.staffPanCardNo = $("#staffPanCardNo").val();
            }
            staff.staffFirstConsultationFee = $("#FreshConsultation").val();
            staff.staffFollowupConsultationFee = $("#ReviewConsultation").val();
            staff.staffMaxConsultationNo = $("#MaximumConsultation").val();
            staff.staffCompensation = $("#staffCompensation").val();
            staff.staffSpecialityIndex = $("#staffAbbrv option:selected").val();
            staff.staffSpecialityAbbrv = $("#staffAbbrv option:selected").text();
            staff.staffAbbrv = $("#staffAbbrv option:selected").text();
//            staff.staffAddress = $("#staffCompensation").val();
            staff.staffCity = $("#staffCity").val();
            staff.staffState = $("#staffState").val();
            staff.staffCountry = $("#staffCountry").val();
            staff.staffTitle = $("#staffTitle option:selected").val();
//            staff.staffIsExtDoctor = $("#staffCompensation").val();
            resource.resourceUnitMap = resUnitMapList;
            resource.resourceWorkingHours = resWhList;
            resource.resourceAvailability = resAvailList;
            staff.staffUnitMap = staffUnitMapList;
            staffList.push(staff);
            resource.staff = staffList;
            resourceList.push(resource);
            user.resource = resourceList;
            dcomethealth.MasterResource.saveUser(user)
                    .done(function (data, textStatus, jqXHR) {
                        dcomethealth.util.loadpage('StaffMaster');
                        alert("Data saved");
                        //requestObj.field1 = data.primaryKey
                    }).fail(function (jqXHR, textStatus, errorThrown) {
                alert("Failed");
                // TO DO
            });
        }
    },
    validateForm: function (form) {
        return  form.validate();
    },
    refreshData: function () {
    }
};
dcomethealth.StaffMaster.init();