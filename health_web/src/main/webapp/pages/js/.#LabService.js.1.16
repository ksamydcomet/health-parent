var dcomethealth = dcomethealth || {};
dcomethealth.sodata = {};
dcomethealth.LabServExtn = {};
dcomethealth.template = null;
dcomethealth.LabService = (function () {
    var id = "LabService";
    function init() {
        $("#main_navigation_bar").append('<div id="' + id + '" class="main_container">');
        $("#" + id).load("pages/html/" + id + ".html", function () {
            dcomethealth.datatypes.applyDataTypes($("#" + id));
//            dcomethealth.ClinicalResource.searchTemplate({"tempType": "Lab"}, function (templates) {
//                dcomethealth.template = templates;
//            });
            var start = moment().startOf('month');
            var end = moment().endOf('month');
            $('#labDateRangeSpan').html(start.format('MMMM D, YYYY') + ' - ' + end.format('MMMM D, YYYY'));
            $('#labDateRange').daterangepicker({
                ranges: {
                    'Today': [moment(), moment()],
                    'Yesterday': [moment().subtract('days', 1), moment().subtract('days', 1)],
                    'Last 7 Days': [moment().subtract('days', 6), moment()],
                    'Last 30 Days': [moment().subtract('days', 29), moment()],
                    'This Month': [moment().startOf('month'), moment().endOf('month')],
                    'Last Month': [moment().subtract('month', 1).startOf('month'), moment().subtract('month', 1).endOf('month')]
                },
                opens: 'left',
                startDate: moment().subtract('days', 29),
                endDate: moment()
            },
            function (start, end) {
                $('#labDateRange span').html(start.format('MMMM D, YYYY') + ' - ' + end.format('MMMM D, YYYY'));
            });
            searchSOByDate();
            searchDoctor();
            dcomethealth.LaboratoryResource.searchLabServiceExtn({}, function (data) {
                dcomethealth.LabServExtn = data;
            });
            var searchObj = {"tempType": "Lab"};
            dcomethealth.ClinicalResource.searchTemplate(searchObj, function (data) {
                dcomethealth.template = data;
            });
            $("#labSave").off("click").on("click", function () {
                saveLabServices();
            });
        });
    }
    function searchSOByDate() {
        $("#aoTbody").empty();
        var date = $('#labDateRangeSpan').html().split('-');
        var searchParamsSO = {"soFromDate": moment(date[0]), "soToDate": moment(date[1]).add(1, 'days'), "soAgainstUnitRID": 4, "sortOrder": ["soState"], "sortDesc": "desc"};
        dcomethealth.CreateOPBilltResource.searchServiceOrders(searchParamsSO, function (data) {
            if (!!data) {
                $.each(data, function (Idx, orders) {
                    var searchParams = {"id": parseInt(orders.soPatientRID)};
                    dcomethealth.PatientResource.searchPatient(searchParams, function (data) {
                        $.each(data, function (pIdx, patient) {
                            $("#aoTbody").append('<tr onclick="dcomethealth.LabService.showResult(' + orders.soPatientRID + ', this)">\n\
                                        <td><output id="orderNo">' + orders.soOrderNo + '</output>\n\
                                            <input type="hidden" id="soDateTime" value="' + orders.soAdviceDateTime + '"/>\n\
                                            <input type="hidden" id="soRid" value="' + orders.id + '"/>\n\
                                            <input type="hidden" id="patRid" value="' + orders.soPatientRID + '"/>\n\
                                            <input type="hidden" id="visitRid" value="' + orders.soVisitRID + '"/></td>\n\
                                        <td><output id="service" >' + orders.soItemName + '</output>\n\
                                            <input type="hidden" id="itemRid" value="' + orders.soItemID + '"/></td>\n\
                                        <td><output id="patMrnNo">' + patient.patMrnNo + '</output></td></tr>');
                        });
                    });
                });
                dcomethealth.sodata = data;
                searchService(dcomethealth.sodata);
            } else {
                var tables = $.fn.dataTable.fnTables(true);
                $(tables).each(function () {
                    $(this).dataTable().fnClearTable();
                    $(this).dataTable().fnDestroy();
                });
                $("#apTbody").empty();
                $("#dyn_table_pat").dataTable({"bJQueryUI": false, "bAutoWidth": false, "bDestroy": true});
                $('.dataTables_filter input').addClass('form-control').attr('placeholder', 'Search...');
                $('.dataTables_length select').addClass('form-control');
            }
        });
    }
    function searchDoctor() {
        dcomethealth.MasterResource.searchStaff({}, function (data) {
            var targetContainer = targetContainer || document;
            $("datalist.dcomet-c-s_doctors-list", targetContainer).each(function (idx, elem) {
                $.each(data, function (pIdx, s_staff) {
                    $(s_staff).each(function () {
                        if (s_staff.staffCategory === 237) {
                            $(elem).append('<option value="' + s_staff.staffName + '">' + s_staff.staffCode + '</option>');
                        }
                    });
                });
            });
        });
    }
    function searchService(soData) {
        var categories = [];
        $("#apTbody").empty();
        $.each(soData, function (index, value) {
            var tables = $.fn.dataTable.fnTables(true);
            $(tables).each(function () {
                $(this).dataTable().fnClearTable();
                $(this).dataTable().fnDestroy();
            });
            if ($.inArray(value.soPatientRID, categories) === -1) {
                categories.push(value.soPatientRID);
                var searchParams = {"id": value.soPatientRID};
                dcomethealth.PatientResource.searchPatient(searchParams, function (data) {
                    $.each(data, function (pIdx, pat) {
                        if (parseInt(value.soState) !== 2) {
                            var stateVal = "Completed";
                            var Print = '<a class="btn btn-success hidden-xs" onclick="dcomethealth.LabService.check(' + pat.id + ',this)"><i class="fa fa-print"></i></a>';
                            var mrn = '<output id="mrn" >' + pat.patMrnNo + '</output>';
                        } else {
                            mrn = '<a href="#" onclick="dcomethealth.LabService.showResult(' + pat.id + ',this)">' + pat.patMrnNo + '</a>';
                            Print = "";
                            stateVal = "Pending";
                        }
                        $("#apTbody").append('<tr><td>' + mrn + '<input type="hidden" id="apPatRid" value="' + pat.id + '"/></td>\n\
                                        <td><output id="service">' + pat.patFullName + '</output></td>\n\
                                        <td><output id="serDate">' + moment(value.createdDateTime, "DD-MM-YYYY HH:mm:ss").format('DD-MM-YYYY') + '</output></td>\n\
                                        <td><output id="serviceStatus">' + stateVal + '</output><td>' + Print + '</td></td></tr>');
                    });
                    $("#dyn_table_pat").dataTable({"bJQueryUI": false, "bAutoWidth": false, "bDestroy": true});
                    $('.dataTables_filter input').addClass('form-control').attr('placeholder', 'Search...');
                    $('.dataTables_length select').addClass('form-control');
                });
            } else {
                var tables = $.fn.dataTable.fnTables(true);
                $(tables).each(function () {
                    $(this).dataTable().fnClearTable();
                    $(this).dataTable().fnDestroy();
                });
                $("#apTbody").empty();
                $("#dyn_table_pat").dataTable({"bJQueryUI": false, "bAutoWidth": false, "bDestroy": true});
                $('.dataTables_filter input').addClass('form-control').attr('placeholder', 'Search...');
                $('.dataTables_length select').addClass('form-control');
            }
        });
    }
    function showResult(val, row) {
        $("#LabServiceHeader").removeClass("panel panel-primary").addClass("hidden");
        $("#add_new").removeClass("hidden").addClass("panel panel-primary");
        var i = 0;
        var searchParams = {"id": val};
        dcomethealth.PatientResource.searchPatient(searchParams, function (data) {
            $.each(data, function (pIdx, pat) {
                $("#patMRN").val(pat.patMrnNo);
                $("#PatientName").text(pat.patFullName);
                $("#patName").val(pat.patName);
                var c = pat.patDob.split('-');
                $('#patAge').val(Math.floor((new Date() - new Date(new Date(c[2], c[1] - 1, c[0]))) / (365.25 * 24 * 60 * 60 * 1000)));
                $('#PatGender').val(pat.patGenderIndex);
                if (parseInt(pat.patGenderIndex) === 1) {
                    $('#PatientGend').val('Male');
                } else if (parseInt(pat.patGenderIndex) === 2) {
                    $('#PatientGend').val('Female');
                } else {
                    $('#PatientGend').val('Transgender');
                }
                $("#soTbody").empty();
                $.each(dcomethealth.sodata, function (pIdx, soFiltered) {
                    if (soFiltered.soPatientRID === val) {
                        var lsDescription = "", lsGroupName = "", lsUOM = "", labSerTempRid = null;
                        $.each(dcomethealth.LabServExtn, function (pIdx, lService) {
                            if (parseInt(lService.lsServiceRID) === parseInt(soFiltered.soItemID)) {
                                if (parseInt(lService.lsAgeMinValue) <= parseInt($('#patAge').val()) && parseInt($('#patAge').val()) <= parseInt(lService.lsAgeMaxValue)) {
                                    if (parseInt((lService.lsGenderType)) === (parseInt($('#PatGender').val()))) {
                                        lsDescription = lService.lsDescription;
                                        lsGroupName = lService.lsGroupName;
                                        lsUOM = lService.lsUom;
                                    } else if (parseInt((lService.lsGenderType)) !== '1' && parseInt((lService.lsGenderType)) !== '2') {
                                        lsDescription = lService.lsDescription;
                                        lsGroupName = lService.lsGroupName;
                                        lsUOM = lService.lsUom;
                                    }
                                }
                                labSerTempRid = lService.lsTemplateRID;
                            }
                        });
                        $("#visitRidIn").val(soFiltered.soVisitRID);
                        $("#patRidIn").val(soFiltered.soPatientRID);
                        if (parseInt(labSerTempRid) !== 0) {
                            var searchObj = {"tempType": "Lab", "id": labSerTempRid};
                            dcomethealth.ClinicalResource.searchTemplate(searchObj, function (data) {
                                $.each(data, function (idx, template) {
                                    if (labSerTempRid == template.id) {
                                        $("#soTbody").append('<tr id="model' + pIdx + '"><td><b><input type="text" id="patService" value= "' + soFiltered.soItemName + '" class="col-md-11" readonly style="border: none"/></b>\n\
                                                <input type="hidden" id="soRidIn" value="' + soFiltered.id + '"/><input type="hidden" id="itemRidIn" value="' + soFiltered.soItemID + '"/>\n\
                                                <input type="hidden" id="lsResultValue" name="lsResultValue" class="col-md-11"/>\n\
                                                <input type="hidden" id="lsDescription" name="lsDescription" class="col-md-11" style="border: none" value=""/>\n\
                                                <input type="hidden" id="lsUom" name="lsUom" class="col-md-11" style="border: none" value=""/>\n\
                                                <input type="hidden" id="lsState" name="lsState" class="col-md-11" style="border: none"/>\n\
                                                <input type="hidden" id="lsGroupName" name="lsGroupName" value=""/><input type="hidden" id="soDate" name="soDate" value=""/></td></tr>');
                                        $("#model" + pIdx).append(template.tempNodes);
                                        $('#itemIdIn').eq(i).attr('id', soFiltered.soItemID);
                                        $('#form-main').eq(i).attr('id', soFiltered.soItemID);
                                        setLabValue(soFiltered.id, soFiltered.soItemID);
                                        return;
                                    }
                                });
                            });
                        } else {
                        $("#soTbody").append('<tr><td><input type="text" id="patService" value= "' + soFiltered.soItemName + '" class="col-md-11" readonly style="border: none"/>\n\
                                    <input type="hidden" id="soRidIn" value="' + soFiltered.id + '"/><input type="hidden" id="itemRidIn" value="' + soFiltered.soItemID + '"/></td>\n\
                                    <td></td>\n\
                                    <td><input type="text" id="lsResultValue" name="lsResultValue" onchange="dcomethealth.LabService.calResult(this)" class="col-md-11" placeholder="Enter result value" /></td>\n\
                                    <td><input type="text" id="lsDescription" name="lsDescription" class="col-md-11" style="border: none" value="' + lsDescription + '"/></td>\n\
                                    <td><input type="text" id="lsUom" name="lsUom" class="col-md-11" style="border: none" value="' + lsUOM + '"/></td>\n\
                                    <td><input type="text" id="lsState" name="lsState" class="col-md-11" style="border: none"/><input type="hidden" id="lsGroupName" name="lsGroupName" value="' + lsGroupName + '"/>\n\
                                        <input type="hidden" id="soDate" name="soDate" value="' + dynTableGetNodeInRow(row, 'serDate').value + '"/></td></tr>');
                    }
                    }
                });
            });
        });
    }
    function check(val, row) {
        var searchParams = {"id": val};
        dcomethealth.PatientResource.searchPatient(searchParams, function (data) {
            $.each(data, function (pIdx, pat) {
                $("#patMRN").val(pat.patMrnNo);
                $("#PatientName").text(pat.patFullName);
                $("#patName").val(pat.patFullName);
                var c = pat.patDob.split('-');
                $("#patAge").val(Math.floor((new Date() - new Date(new Date(c[2], c[1] - 1, c[0]))) / (365.25 * 24 * 60 * 60 * 1000)));
                if (parseInt(pat.patGenderIndex) == 1) {
                    $("#PatientGend").val('Male');
                } else if (parseInt(pat.patGenderIndex) == 2) {
                    $("#PatientGend").val('Female');
                } else {
                    $("#PatientGend").val('Transgender');
                }
                $("#soTbody").empty();
                $.each(dcomethealth.sodata, function (aIdx, data) {
                    if (data.soPatientRID == val) {
                        $.each(data.labResultDList, function (pIdx, labResult) {
                            $("#soTbody").append('<tr><td><input type="text" id="patService" value= "' + labResult.lrdNServName + '" />\n\
                                        <input type="hidden" id="soRidIn" value="' + data.id + '"/><input type="hidden" id="itemRidIn" value="' + data.soItemID + '"/></td>\n\
                                        <td><input type="text" id="lsResultValue" name="lsResultValue" value= "' + labResult.lrdNR + '"/></td>\n\
                                        <td><input type="text" id="lsDescription" name="lsDescription" class="col-md-11" style="border: none" value="' + labResult.lrdNServRange + '"/></td>\n\
                                        <td><input type="text" id="lsUom" name="lsUom" class="col-md-11" style="border: none" value="' + labResult.lrdNServUnit + '"/></td>\n\
                                        <td><input type="text" id="lsState" name="lsState" value= "' + labResult.lrdTTempValue + '" class="col-md-11" style="border: none"/>\n\
                                    </td></tr>');
                        });
                    }
                });
                exportExcel();
            });
        });
    }
    function calResult(row) {
        var searchParams = {"lsServiceRID": parseInt(dynTableGetNodeInRow(row, 'itemRidIn').value)};
        dcomethealth.LaboratoryResource.searchLabServiceExtn(searchParams, function (data) {
            $.each(data, function (pIdx, lService) {
                if (parseInt(lService.lsAgeMinValue) <= parseInt($('#patAge').val()) && parseInt($('#patAge').val()) <= parseInt(lService.lsAgeMaxValue)) {
                    if (parseInt((lService.lsGenderType)) === (parseInt($('#PatGender').val()))) {
                        if (parseFloat(lService.lsRangeMinValue) <= parseFloat(dynTableGetNodeInRow(row, 'lsResultValue').value) && parseFloat(dynTableGetNodeInRow(row, 'lsResultValue').value) <= parseFloat(lService.lsRangeMaxValue)) {
                            dynTableGetNodeInRow(row, 'lsState').value = "Normal Range";
                        } else if (parseFloat(dynTableGetNodeInRow(row, 'lsResultValue').value) < parseFloat(lService.lsRangeMinValue)) {
                            dynTableGetNodeInRow(row, 'lsState').value = "Low Range";
                        } else if (parseFloat(dynTableGetNodeInRow(row, 'lsResultValue').value) > parseFloat(lService.lsRangeMaxValue)) {
                            dynTableGetNodeInRow(row, 'lsState').value = "High Range";
                        }
                    } else if (parseInt((lService.lsGenderType)) !== 1 && parseInt((lService.lsGenderType)) !== 2) {
                        if (parseFloat(lService.lsRangeMinValue) <= parseFloat(dynTableGetNodeInRow(row, 'lsResultValue').value) && parseFloat(dynTableGetNodeInRow(row, 'lsResultValue').value) <= parseFloat(lService.lsRangeMaxValue)) {
                            dynTableGetNodeInRow(row, 'lsState').value = "Normal Range";
                        } else if (parseFloat(dynTableGetNodeInRow(row, 'lsResultValue').value) < parseFloat(lService.lsRangeMinValue)) {
                            dynTableGetNodeInRow(row, 'lsState').value = "Low Range";
                        } else if (parseFloat(dynTableGetNodeInRow(row, 'lsResultValue').value) > parseFloat(lService.lsRangeMaxValue)) {
                            dynTableGetNodeInRow(row, 'lsState').value = "High Range";
                        }
                    }
                }
            });
        });
    }
    function setLabValue(soRid, itemRID) {
        var form = $('form#' + itemRID);
        var f = form.serializeArray();
        $.each(dcomethealth.sodata, function (aIdx, data) {
            if (parseInt(data.id) == parseInt(soRid)) {
                $.each(data.labResultDList, function (pIdx, labResultd) {
                    if (parseInt(soRid) == parseInt(labResultd.lrdHRID)) {
                        var obj = jQuery.parseJSON(labResultd.lrdNodes);
                        $.each(obj, function (idx, val) {
                            $.each(f, function () {
                                if (this.name == idx) {
                                    $('#' + this.name).val(val);
                                }
                            });
                        });
                    }
                });
            }
        });
    }
    function getLabValue(itmRID) {
        var form = $('form#' + itmRID);
        var o = {};
        var a = form.serializeArray();
        if (a.length != 0) {
            $.each(a, function () {
                if (o[this.name]) {
                    !o[this.name].push ? o[this.name] = [o[this.name]] : o[this.name].push(this.value || null);
                } else {
                    !!this.value ? o[this.name] = this.value || null : null;
                }
            });
            return o;
        } else {
            return undefined;
        }
    }
    function saveLabServices() {
        if ($('#patDoc').val() === "") {
            alert("Select Doctor Name");
            return false;
        }
        var serviceOrderList = [];
        var tablels = document.getElementById('ls_table');
        for (var i = 0; i < tablels.rows.length - 1; i++) {
            var serviceOrder = {}, labService = {};
            var labResultDList = [];
            serviceOrder.id = dynTableGetNodeInRow(tablels.rows[i + 1], 'soRidIn').value;
            serviceOrder.soPatientRID = $("#patRidIn").val();
            !!$("#visitRidIn").val() ? serviceOrder.soVisitRID = $("#visitRidIn").val() : null;
            serviceOrder.soOrderingUnitRID = dcomethealth.selectedunit;
            serviceOrder.soOrderType = 1;
            serviceOrder.soItemID = dynTableGetNodeInRow(tablels.rows[i + 1], 'itemRidIn').value;
            serviceOrder.soItemName = dynTableGetNodeInRow(tablels.rows[i + 1], 'patService').value;
            serviceOrder.soQty = 1;
            serviceOrder.soProcessingUnitRID = dcomethealth.selectedunit;
            serviceOrder.soProcessedBY = $("#patDoc").val();
            serviceOrder.soRemarks = $("#patRemarks").val();
            var itemRID = dynTableGetNodeInRow(tablels.rows[i + 1], 'itemRidIn').value;
            var labNode = !!dynTableGetNodeInRow(tablels.rows[i + 1], 'itemRidIn').value ? JSON.stringify(getLabValue(itemRID)) : null;
            labService.lrdNodes = !!labNode ? labNode : null;
//            labService.id = !!dynTableGetNodeInRow(tablels.rows[i + 1], 'itemRidIn').value ? dynTableGetNodeInRow(tablels.rows[i + 1], 'itemRidIn').value : null;
            labService.lrdNServName = !!dynTableGetNodeInRow(tablels.rows[i + 1], 'patService').value ? dynTableGetNodeInRow(tablels.rows[i + 1], 'patService').value : null;
            labService.lrdNR = !!dynTableGetNodeInRow(tablels.rows[i + 1], 'lsResultValue').value ? dynTableGetNodeInRow(tablels.rows[i + 1], 'lsResultValue').value : null;
            labService.lrdNServUnit = !!dynTableGetNodeInRow(tablels.rows[i + 1], 'lsUom').value ? dynTableGetNodeInRow(tablels.rows[i + 1], 'lsUom').value : null;
            labService.lrdNServRange = !!dynTableGetNodeInRow(tablels.rows[i + 1], 'lsDescription').value ? dynTableGetNodeInRow(tablels.rows[i + 1], 'lsDescription').value : null;
            labResultDList.push(labService);
            serviceOrder.labResultDList = labResultDList;
            serviceOrderList.push(serviceOrder);
        }
        dcomethealth.ServiceOrderResource.saveServiceOrderResult(serviceOrderList)
                .done(function (data, textStatus, jqXHR) {
                    if (confirm("Data Saved Proceed to Print")) {
//                        dcomethealth.LabService.exportExcel();
                        dcomethealth.util.loadpage('LabService');
                        dcomethealth.util.base_init();
                    } else {
                        dcomethealth.util.loadpage('LabService');
                        dcomethealth.util.base_init();
                    }
                }).fail(function (jqXHR, textStatus, errorThrown) {
            alert("Failed to Save");
        });
    }
    function generatePageByGroupName(groupName) {
        var tablels = document.getElementById('ls_table');
        var table_length = tablels.rows.length;
        var a = 0, itemRID = null, soRID = null;
        $("#ExportHeamatologyTable").append('<tr id="trTable"><td><table id="' + groupName + '" width="100%"><tr> <td> <table width="100%"> <tr> <td width="18%"><img src="#" alt="Logo" style="max-height: 180px; max-width: 100px; visibility:hidden;" id="entityImagePath' + groupName + '"/></td><td width="69%"> <p><strong><span style="visibility:hidden;" id="entityName' + groupName + '"> </span></strong><strong><br/></strong><small> <span style="visibility:hidden;" id="entityDisplayName' + groupName + '"></span><br/><span style="visibility:hidden;">Telefone: </span><span  style="visibility:hidden;" id="entityPhone' + groupName + '"></span><br/><span  style="visibility:hidden;">Email:</span> <span id="entityEmail' + groupName + '" style="visibility:hidden;"></span><span style="visibility:hidden;">Website:</span> <span style="visibility:hidden;" id="entityWebSite' + groupName + '"></span></small> </p></td><td width="13%" style="visibility:hidden;"><small>Original</small></td></tr></table> </td></tr><tr> <td></td></tr><tr > <td> <p align="center" style="background-color: #FF9900 !important;-webkit-print-color-adjust: exact; border: 1px solid #FF9900; padding:5px; visibility:hidden;"><small>REPORT</small></p></td></tr><tr><td></td></tr><tr><td></td></tr><tr><td></td></tr><tr><td></td></tr><tr><td></td></tr><tr> <td> <tr> <td> <table style="float: left;" width="60%"><tr><td width="20%"><span style="visibility:hidden;"><small>Name</small></span></td><td style="visibility:hidden;"></td><td width="78%"><small><span style="margin-left:70px;" id="PatientName' + groupName + '" ></span></small></td></tr><tr><td></td></tr><tr> <td width="20%" style="visibility:hidden;"><small>Age</small></td><td style="visibility:hidden;">:</td><td width="78%"><small> <span style="margin-left:70px;" id="PatientAge' + groupName + '"></span><span> / </span><span id="PatientGender' + groupName + '"></span></small></td></tr><tr> <td width="20%" style="visibility:hidden;"><small>Gender</small> </td><td style="visibility:hidden;">:</td><td width="78%"></td></tr><tr> <td width="20%" ><span style="visibility:hidden;"><small>Corporate</small></span></td><td style="visibility:hidden;">:</td><td width="78%"><small><span id="corporate"></span></small></td></tr></table> <table style="float: right;" width="40%"> <tr> <td width="25%" style="visibility:hidden;"><small>Uhid</small></td><td style="visibility:hidden;">:</td><td width="78%"><small><span id="uhid' + groupName + '"></span></small></td></tr><tr> <td width="25%" style="visibility:hidden;"><small>Reg No</small></td><td style="visibility:hidden;">:</td><td width="78%"><small> <span id="regNo"></span></small></td></tr><tr> <td width="25%" style="visibility:hidden;"><small>Reg Date</small></td><td style="visibility:hidden;">:</td><td width="78%"><small><span id="RegOn' + groupName + '"></span></small></td></tr><tr><td></td></tr><tr><td></td></tr><tr><td></td></tr><tr> <td width="30%" style="visibility:hidden;"><small>Collected On</small></td><td style="visibility:hidden;">:</td><td style="text-align: left;" width="68%"><small><span id="ColOn">' + moment().format('DD-MM-YYYY') + '</span></small></td></tr><tr> <td width="30%" style="visibility:hidden;"><small>Reported On</small></td><td style="visibility:hidden;">:</td><td style="text-align: left;" width="68%"><small><span id="RepOn">' + moment().format('DD-MM-YYYY') + '</span></small></td></tr></table> </td></tr><table><tr><td></td></tr><tr><td></td></tr><tr><td></td></tr><tr><td></td></tr><tr><td></td></tr><tr><td></td></tr><tr><td></td></tr><tr><td></td></tr><tr><td></td></tr><tr><td></td></tr><tr><td></td></tr><tr><td></td></tr><tr><td></td></tr><tr><td></td></tr><tr><td></td></tr><tr><td></td></tr><tr><td></td></tr><tr><td></td></tr><tr><td></td></tr><tr><td></td></tr></table><tr><td><table width="100%" style="margin-top: -50px;"> <tr> <td></td></tr><tr> <td> <table width="100%"> <tr> <td> <table style="border-style: none;" border="0" width="100%" cellspacing="0" cellpadding="0"> <thead> <caption id="groupName' + groupName + '" style="background-color: #FF9900 !important;-webkit-print-color-adjust: exact;font-size: 12px;border: 1px solid #FF9900;padding: 4px;border-radius:15px;margin-bottom: 10px;visibility:hidden;"><small></small></caption> <tr> <th style="font-size: 12px;background-color: #FF9900 !important; -webkit-print-color-adjust: exact; text-align: center; border: 1px solid #FF9900;padding: 2px;border-radius:15px;visibility:hidden;" width="37%">Test Name</th> <th style="font-size: 12px;background-color: #FF9900 !important; -webkit-print-color-adjust: exact;text-align: center; border: 1px solid #FF9900;padding: 2px; border-radius:15px;visibility:hidden;" width="15%">Result</th> <th style="font-size: 12px;background-color: #FF9900 !important; -webkit-print-color-adjust: exact; text-align: center; border: 1px solid #FF9900;padding: 2px;border-radius:15px;visibility:hidden;" width="14%">Units</th> <th style="font-size: 12px;background-color: #FF9900 !important; -webkit-print-color-adjust: exact;text-align: center; border: 1px solid #FF9900;padding: 2px;border-radius:15px;visibility:hidden;" width="22%">Biological Reference Intervals</th </tr></thead> <tbody id="exp_H_tbody' + groupName + '" ></tbody> </table> </td></tr><br><tr> <td> <p style="padding: 5px;visibility:hidden;" align="left"> <small>Impression :</small> <br/> </td></tr><tr> <td width="75%"> <p id="descriptionReport"></p></td></tr><br/> <tr> <td> <p align="center" style="visibility:hidden;"><small>------End Of Report------</small></p></td></tr></table></td></tr></table></td></tr></td></tr></table></td></tr>');
        $('#entityName' + groupName + '').text(dcomethealth.userEntityName);
        $('#entityDisplayName' + groupName + '').text(dcomethealth.userEntityDisplayAddress);
        $('#entityEmail' + groupName + '').text(dcomethealth.userEntityMail);
        $('#entityPhone' + groupName + '').text(dcomethealth.userEntityPhone);
        $('#entityImagePath' + groupName + '').prop('src', dcomethealth.userEntityPath);
        $('#entityWebSite' + groupName + '').text(dcomethealth.userEntityWebSite);
        $('#PatientName' + groupName + '').text($('#patName').val());
        $('#PatientGender' + groupName + '').text($('#PatientGend').val());
        $('#PatientAge' + groupName + '').text($('#patAge').val());
        $('#uhid' + groupName + '').text($('#patMRN').val());
        $('#groupName' + groupName).text(groupName);
        for (var i = 0; i < table_length - 1; i++) {
            itemRID = dynTableGetNodeInRow(tablels.rows[i + 1], 'itemRidIn').value;
            soRID = dynTableGetNodeInRow(tablels.rows[i + 1], 'soRidIn').value;
            $.each(dcomethealth.sodata, function (aIdx, data) {
                if (parseInt(data.id) == parseInt(soRID)) {
                    $.each(data.labResultDList, function (pIdx, labResultD) {
                        if (!!labResultD.lrdNodes) {
                            $.each(dcomethealth.template, function (pIdx, template) {
                                if (parseInt(itemRID) == parseInt(template.tempRID)) {
                                    $("#exp_H_tbody" + groupName).append('<tr style="margin-top: 200px;"><td style="border-style: none !important; padding: 5px; font-size: 12px; white-space: nowrap;" >' + dynTableGetNodeInRow(tablels.rows[i + 1], 'patService').value + '</td></small></tr>');
                                    $("#exp_H_tbody" + groupName).append(template.tempNodes);
                                    $('#form-main').eq(a).attr('id', itemRID);
                                    $("#exp_H_tbody :input").css('border', '0');
                                    setLabValue(soRID, itemRID);
                                }
                            });
                        } else {
                            $("#exp_H_tbody" + groupName).append('<tr style="margin-top: 200px;"><td style="border-style: none !important; padding: 5px; font-size: 12px;" width="40%">' + dynTableGetNodeInRow(tablels.rows[i + 1], 'patService').value + '</td></small><small><td style="border-style: none !important;font-size: 12px;text-align: center;" width="15%">' + dynTableGetNodeInRow(tablels.rows[i + 1], 'lsResultValue').value + '</td></small><small><td style="border-style: none !important;text-align: center;font-size: 12px;" width="15%">' + dynTableGetNodeInRow(tablels.rows[i + 1], 'lsUom').value + '</td></small><small><td style="border-style: none !important;text-align: center;font-size: 12px;"width="30%">' + dynTableGetNodeInRow(tablels.rows[i + 1], 'lsDescription').value + '</td></small></tr>');
                        }
                    });
                }
            });
//            if ((dynTableGetNodeInRow(tablels.rows[i + 1], 'lsGroupName').value).toUpperCase() === groupName) {
//            $('#RegOn' + groupName + i).text((dynTableGetNodeInRow(tablels.rows[i + 1], 'soDate').value).toUpperCase());
//            $("#exp_H_tbody" + groupName).append('<tr style="margin-top: 200px;"><td style="border-style: none !important; padding: 5px; font-size: 12px;" width="40%">' + dynTableGetNodeInRow(tablels.rows[i + 1], 'patService').value + '</td></small><small><td style="border-style: none !important;font-size: 12px;text-align: center;" width="15%">' + dynTableGetNodeInRow(tablels.rows[i + 1], 'lsResultValue').value + '</td></small><small><td style="border-style: none !important;text-align: center;font-size: 12px;" width="15%">' + dynTableGetNodeInRow(tablels.rows[i + 1], 'lsUom').value + '</td></small><small><td style="border-style: none !important;text-align: center;font-size: 12px;"width="30%">' + dynTableGetNodeInRow(tablels.rows[i + 1], 'lsDescription').value + '</td></small></tr>');
//                if (parseInt(i + 1) < parseInt(table_length - 1)) {
//                    document.getElementById(i + 1).style.pageBreakAfter = "always";
//                }
//                grpNameOld = dynTableGetNodeInRow(tablels.rows[i + 1], 'lsGroupName').value;
//            }
//            if (dynTableGetNodeInRow(tablels.rows[i + 1], 'lsGroupName').value !== groupName) {
//                document.getElementById(i + 1).style.pageBreakAfter = "always";
//            }
        }
    }
    function exportExcel() {
//        var groupNames = [];
        $("#exp_H_tbody").empty();
//        var tablels = document.getElementById('ls_table');
//        var table_length = tablels.rows.length;
//        for (var i = 0; i < table_length - 1; i++) {
//            var lsGroupName = dynTableGetNodeInRow(tablels.rows[i + 1], 'lsGroupName').value;
//            if ($.inArray(lsGroupName, groupNames) <= -1) {
//                groupNames.push(lsGroupName);
        var name = "";
        generatePageByGroupName(name);
//        document.getElementById(totalTable).style.pageBreakAfter = "avoid";
        var htmltable = document.getElementById('ExportHeamatologyTable');
        var html = htmltable.outerHTML;
        var printWindow = window.open('', '_blank');
        printWindow.document.write(html);
        printWindow.document.close();
        printWindow.focus();
        printWindow.print();
        printWindow.close();
        dcomethealth.util.loadpage('LabService');
        dcomethealth.util.base_init();
    }
    function refreshData() {
    }
    return {
        init: init,
        searchSOByDate: searchSOByDate,
        searchDoctor: searchDoctor,
        searchService: searchService,
        showResult: showResult,
        check: check,
        calResult: calResult,
        getLabValue: getLabValue,
        setLabValue: setLabValue,
        saveLabServices: saveLabServices,
        generatePageByGroupName: generatePageByGroupName,
        exportExcel: exportExcel,
        refreshData: refreshData
    };
}());
dcomethealth.LabService.init();

